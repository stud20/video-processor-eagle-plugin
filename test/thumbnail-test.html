<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>썸네일 테스트</title>
    <style>
        body {
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-section {
            background: #2d3748;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .thumbnail-test {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .thumbnail-item {
            background: #1a202c;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .thumbnail-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .debug-info {
            background: #1a202c;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #3182ce;
        }
    </style>
</head>
<body>
    <h1>🖼️ Video Processor 썸네일 테스트</h1>
    
    <div class="test-section">
        <h2>테스트 도구</h2>
        <button onclick="testBase64Conversion()">Base64 변환 테스트</button>
        <button onclick="testFileAccess()">파일 접근 테스트</button>
        <button onclick="testSmartGroups()">스마트 그룹 데이터 확인</button>
    </div>
    
    <div class="test-section">
        <h2>썸네일 미리보기</h2>
        <div id="thumbnailTest" class="thumbnail-test"></div>
    </div>
    
    <div class="test-section">
        <h2>디버그 정보</h2>
        <div id="debugInfo" class="debug-info"></div>
    </div>

    <script>
        // 디버그 로그 출력
        function log(message, data) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${timestamp}] ${message}\n`;
            if (data) {
                debugDiv.innerHTML += JSON.stringify(data, null, 2) + '\n\n';
            }
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        // Base64 변환 테스트
        async function testBase64Conversion() {
            log('Base64 변환 테스트 시작...');
            
            // 테스트용 이미지 생성 (Canvas API 사용)
            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 240;
            const ctx = canvas.getContext('2d');
            
            // 그라데이션 배경
            const gradient = ctx.createLinearGradient(0, 0, 320, 240);
            gradient.addColorStop(0, '#4299e1');
            gradient.addColorStop(1, '#48bb78');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 320, 240);
            
            // 텍스트
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('테스트 썸네일', 160, 120);
            
            // Base64로 변환
            const base64 = canvas.toDataURL('image/jpeg', 0.8);
            log('Base64 생성 완료', { length: base64.length });
            
            // 썸네일 표시
            displayThumbnail(base64, 'Canvas 테스트');
        }

        // 파일 접근 테스트
        function testFileAccess() {
            log('파일 접근 테스트...');
            
            if (window.require) {
                const fs = window.require('fs');
                const path = window.require('path');
                const os = window.require('os');
                
                const testPath = path.join(os.homedir(), '.video-processor-cache', 'analysis');
                log('테스트 경로', { testPath });
                
                if (fs.existsSync(testPath)) {
                    const files = fs.readdirSync(testPath);
                    log('찾은 파일들', files);
                    
                    // JPG 파일만 필터링
                    const jpgFiles = files.filter(f => f.endsWith('.jpg'));
                    jpgFiles.forEach(file => {
                        const filePath = path.join(testPath, file);
                        const stats = fs.statSync(filePath);
                        log(`파일: ${file}`, { size: stats.size });
                        
                        // Base64로 변환
                        try {
                            const buffer = fs.readFileSync(filePath);
                            const base64 = `data:image/jpeg;base64,${buffer.toString('base64')}`;
                            displayThumbnail(base64, file);
                        } catch (err) {
                            log(`파일 읽기 실패: ${file}`, err);
                        }
                    });
                } else {
                    log('디렉토리가 존재하지 않습니다', { testPath });
                }
            } else {
                log('Node.js 모듈을 사용할 수 없습니다 (Eagle 외부 환경)');
            }
        }

        // 스마트 그룹 데이터 확인
        function testSmartGroups() {
            log('스마트 그룹 데이터 확인...');
            
            if (window.VideoProcessor && window.VideoProcessor.smartGroups) {
                const groups = window.VideoProcessor.smartGroups;
                log(`총 ${groups.length}개 그룹 발견`);
                
                groups.forEach((group, index) => {
                    log(`그룹 #${group.id}`, {
                        members: group.members.length,
                        isGroup: group.isGroup,
                        avgSimilarity: group.avgSimilarity
                    });
                    
                    // 각 멤버의 썸네일 확인
                    group.members.forEach((member, memberIndex) => {
                        if (member.thumbnail) {
                            displayThumbnail(member.thumbnail, `그룹${group.id}-멤버${memberIndex}`);
                            log(`썸네일 발견: 그룹${group.id}-멤버${memberIndex}`, {
                                hasThumb: true,
                                length: member.thumbnail.length
                            });
                        } else {
                            log(`썸네일 없음: 그룹${group.id}-멤버${memberIndex}`, {
                                framePath: member.framePath
                            });
                        }
                    });
                });
            } else {
                log('스마트 그룹 데이터가 없습니다');
            }
        }

        // 썸네일 표시
        function displayThumbnail(base64, label) {
            const container = document.getElementById('thumbnailTest');
            const item = document.createElement('div');
            item.className = 'thumbnail-item';
            item.innerHTML = `
                <img src="${base64}" class="thumbnail-img" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23333%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 fill=%22%23999%22%3E❌%3C/text%3E%3C/svg%3E'">
                <div>${label}</div>
            `;
            container.appendChild(item);
        }

        // 페이지 로드 시 초기 정보 표시
        window.onload = function() {
            log('테스트 페이지 로드 완료');
            log('Eagle 환경 확인', {
                hasEagle: typeof eagle !== 'undefined',
                hasRequire: typeof window.require !== 'undefined'
            });
        };
    </script>
</body>
</html>
